# Backend Authentication Issue Summary

## Problem
After disabling `ENABLE_AUTH_BYPASS=false` on Railway, the iOS app shows "Guest User" in Settings and gets 401 errors on all API calls, even after signing out and signing back in.

## Root Cause
The backend has a critical JWT validation bug. It successfully generates valid Supabase JWT tokens during login but immediately rejects them as "Invalid token" when used for API requests.

## Evidence

### 1. Auth Bypass is Properly Disabled
```
GET /api/v1/users/me (without token) → 401 Unauthorized ✅
GET /api/v1/products/recommendations (without token) → 401 Unauthorized ✅
```

### 2. Login Works and Returns Valid JWT
```
POST /api/v1/auth/login
Response: 200 OK
{
  "access_token": "eyJhbGciOiJIUzI1NiIsImtpZCI6In...", // Valid 802-char Supabase JWT
  "token_type": "bearer"
}
```

JWT Contents:
- Valid Supabase JWT with 1-hour expiry
- Contains correct user data
- Issued by: `https://ksgxendfsejkxhrmfsbi.supabase.co/auth/v1`
- Role: `authenticated`
- Has valid `sub` (user ID) claim

### 3. Token Immediately Rejected
```
GET /api/v1/users/me
Authorization: Bearer <valid_token_from_login>
Response: 401 Unauthorized
{
  "detail": "Invalid token"
}
```

## Backend Code Analysis

The backend's `dependencies.py` shows it tries to verify tokens in this order:
1. First attempts Supabase client verification (`supabase.auth.get_user(token)`)
2. If that fails, falls back to manual JWT decoding

The manual decoding has signature verification disabled for Supabase tokens, but the token still gets rejected, suggesting the Supabase client verification is failing and the fallback isn't working properly.

## Impact on iOS App

1. Users can create accounts and login (gets valid token)
2. Token is stored correctly in iOS Keychain
3. All API calls fail with 401 because backend rejects the valid token
4. Settings shows "Guest User" as fallback when API calls fail
5. Explore tab shows 401 errors

## Temporary Workaround

The only current workaround is to re-enable `ENABLE_AUTH_BYPASS=true` on Railway, which will make the app work but show "Development User" for everyone.

## Required Fix

The backend team needs to:
1. Fix the JWT validation logic in `app/internal/dependencies.py`
2. Ensure Supabase client is properly configured with correct JWT secret
3. Test that tokens generated by login can be used for API calls

## Test Scripts Created

1. `test_auth_bypass_status.py` - Confirms auth bypass is disabled
2. `test_backend_auth.py` - Tests the full auth flow
3. `test_ios_auth_flow.py` - Simulates iOS app authentication
4. `debug_backend_jwt.py` - Analyzes JWT tokens and validation
5. `test_supabase_config.py` - Tests Supabase configuration

All scripts confirm the same issue: valid tokens are generated but immediately rejected.